<!doctype html>
<html>
<head>

  <!--JQUERY-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

<link rel="stylesheet" href="/css/style.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
<script src="sha256.js"></script>

</head>


<body>

  <div class="main-chat-login">
    <div class="container">
      <h1>This is the login</h1>

      <div class="row">
        <div class="col-sm-12">
            <input type="text" class="btn-block" id="email" value="" placeholder="Your e-mail address" />
        </div>
        <div class="col-sm-12">
          <input type="text" class="btn-block" id="password" value="" placeholder="Your password" />
        </div>
        <div class="col-sm-12">
          <button type="button" class="btn btn-block btn-primary" id="login-button">Login</button>
        </div>
        <div class="col-sm-12">
          <button type="button" class="btn btn-block btn-danger" id="register-display-button">Register</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-chat-register">
    <div class="container">
      <h1>This is the register window</h1>

      <div class="row">
        <div class="col-sm-12">
            <input type="text" class="btn-block" id="register-name" value="" placeholder="Your Name" />
        </div>
        <div class="col-sm-12">
            <input type="text" class="btn-block" id="register-email" value="" placeholder="Your e-mail address" />
        </div>
        <div class="col-sm-12">
          <input type="text" class="btn-block" id="register-password" value="" placeholder="Your password" />
        </div>
        <div class="col-sm-12">
          <label>Photo</label>
          <input type="file" id="photo" />
        </div>
        <div class="col-sm-12">
          <button type="button" class="btn btn-block btn-primary" id="register-button">Register</button>
        </div>
        <div class="col-sm-12">
          <button type="button" class="btn btn-block btn-danger" id="login-window-button">Login</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-chat-display">
    <h1><img src="" id="displayphoto" style="height: 200px;width: 200px;" /> <span id="displayname"></span></h1>
    <div class="container">
      <div class="row">
          <div class="col-sm-12" style="background: #ff0;"><p style="text-align:center;">This is a big row!</p></div>

          <div class="col-sm-3" style="background: #f0f;min-height: 300px;">
            <p>This is my sidebar!</p>
          </div>
          <div class="col-sm-9" style="background: #00F;min-height: 300px;">

            <div class="row">
              <div class="col-sm-12" style="background: #0ff;height: 150px;">
                <p id="robstring">This is my string, it contains three links, www.tsn.ca, http://www.cnn.com/, and facebook.com</p>
              </div>
            </div>
            <div class="row">
              <div class="col-sm-9" style="background: #F00;margin-top: 20px;padding-top: 20px;">
                <input type="text" id="ahmed-test-name" class="btn-block" />
              </div>
              <div class="col-sm-3">
                <button type="button" id="thebutton" class="btn btn-rachael btn-block">Ahmed's button</button>
              </div>
            </div>
          </div>
      </div>
      <div class="row">
        <div class="col-sm-4">
        </div>
      </div>
    </div>
  </div>


  <script>

    var myDataRef = new Firebase("https://uitfirechat.firebaseio.com");
    var string = $("#robstring").html();
    //alert(string);

    // function handleFileSelect(evt) {
    //   var f = evt.target.files[0];
    //   var reader = new FileReader();
    //   reader.onload = (function(theFile) {
    //     return function(e) {
    //       var filePayload = e.target.result;
    //       // Generate a location that can't be guessed using the file's contents and a random number
    //       var hash = CryptoJS.SHA256(Math.random() + CryptoJS.SHA256(filePayload));
    //       var f = new Firebase(firebaseRef + 'photos/' + hash + '/filePayload');
    //       // Set the file payload to Firebase and register an onComplete handler to stop the spinner and show the preview
    //       f.set(filePayload, function() { 
    //         document.getElementById("pano").src = e.target.result;
    //         $('#file-upload').hide();
    //         // Update the location bar so the URL can be shared with others
    //         window.location.hash = hash;
    //       });
    //     };
    //   })(f);
    //   reader.readAsDataURL(f);
    // }


    var formattedString = string.replace(/(?:(?:ht|f)tp(?:s?)\:\/\/|~\/|\/)?(?:\w+:\w+@)?((?:(?:[-\w\d{1-3}]+\.)+(?:com|org|net|gov|mil|biz|info|mobi|name|aero|jobs|edu|co\.uk|ac\.uk|it|fr|tv|museum|asia|local|travel|[a-z]{2}))|((\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)(\.(\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)){3}))(?::[\d]{1,5})?(?:(?:(?:\/(?:[-\w~!$+|.,=]|%[a-f\d]{2})+)+|\/)+|\?|#)?(?:(?:\?(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)(?:&(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)*)*(?:#(?:[-\w~!$ |\/.,*:;=]|%[a-f\d]{2})*)?/ig, "<a href='http://$1'>$1</a>");

    //alert(formattedString);
    $("#robstring").html(formattedString);

    $(document).ready(function() {

      function authDataCallback(authData) {
        if (authData) {
          alert("User " + authData.uid + " is logged in with " + authData.provider);
          console.log("User " + authData.uid + " is logged in with " + authData.provider);
        } else {
          console.log("User is logged out");
        }
      }

      myDataRef.onAuth(authDataCallback);
      
      $("#register-display-button").click(function() {
        $(".main-chat-login").hide();
        $(".main-chat-register").show();
      });

      $("#login-window-button").click(function() {
        $(".main-chat-register").hide();
        $(".main-chat-login").show();
      });

      $("#login-button").click(function() {
        var email = $("#email").val();
        var password = $("#password").val();

        myDataRef.authWithPassword({
          email    : email,
          password : password
        }, function(error, authData) {
          if (error) {
            console.log("Login Failed!", error);
          } else {
            console.log("Authenticated successfully with payload:", authData);

            myDataRef.child('user').child(authData.uid).once("value", function(snapshot) {

              var user = snapshot.val();

              for (var key in user) {
                $("#displayname").html(user[key].name);
                document.getElementById("displayphoto").src = user[key].photo;
              } 
            });            

            $(".main-chat-login").hide();
            $(".main-chat-display").show();
          }
        });
      });

      $("#register-button").click(function() {
        var name = $("#register-name").val();
        var email = $("#register-email").val();
        var password = $("#register-password").val();

        myDataRef.createUser({
          email    : email,
          password : password
        }, function(error, userData) {
          if (error) {
            console.log("Error creating user:", error);
          } else {
            console.log("Successfully created user account with uid:", userData.uid);

            var photoinput = document.getElementById('photo');
            var f = photoinput.files[0];
            var reader = new FileReader();
            reader.onload = (function(theFile) {
              return function(e) {
                var filePayload = e.target.result;
                // Generate a location that can't be guessed using the file's contents and a random number
                //var hash = CryptoJS.SHA256(Math.random() + CryptoJS.SHA256(filePayload));
                var firebasephoto = new Firebase(myDataRef + 'photos/' + userData.uid + '/filePayload');
                // Set the file payload to Firebase and register an onComplete handler to stop the spinner and show the preview
                firebasephoto.set(filePayload, function() { 

                  myDataRef.child('user').child(userData.uid).push({id:userData.uid, email:email, name:name, photo:e.target.result}); 

                  myDataRef.authWithPassword({
                    email    : email,
                    password : password
                  }, function(error, authData) {
                    if (error) {
                      console.log("Login Failed!", error);
                    } else {
                      console.log("Authenticated successfully with payload:", authData);
                      $(".main-chat-register").hide();
                      $(".main-chat-display").show();
                    }
                  });
                  
                });
              };
            })(f);
            reader.readAsDataURL(f);

            
          }
        });
      });
    });
  </script>
</body>
</html>
